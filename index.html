<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Presen√ßa com Reconhecimento Facial</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .sync-status {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px auto;
            display: inline-block;
            backdrop-filter: blur(10px);
        }
        
        .sync-status.synced {
            background: rgba(40, 167, 69, 0.3);
        }
        
        .sync-status.syncing {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover {
            background: #5a6fd8;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .camera-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        #video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .person-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .person-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .person-card:hover {
            transform: translateY(-5px);
        }
        
        .person-card.present {
            background: #d4edda;
            border-left: 5px solid #28a745;
        }
        
        .person-card.facial-only {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        
        .person-card.confirmed {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            box-shadow: 0 4px 20px rgba(23, 162, 184, 0.3);
        }
        
        .person-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .person-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.present {
            background: #28a745;
            color: white;
        }
        
        .status.absent {
            background: #dc3545;
            color: white;
        }
        
        .status.facial-only {
            background: #ffc107;
            color: #212529;
        }
        
        .status.confirmed {
            background: #17a2b8;
            color: white;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-container label {
            cursor: pointer;
            font-weight: bold;
            margin: 0;
        }
        
        .recognition-result {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .recognition-result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .recognition-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .invite-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .invite-link {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        
        .sync-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }
        
        .data-storage {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #28a745;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .person-list {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Sistema de Presen√ßa</h1>
            <p>Reconhecimento facial inteligente para controle de presen√ßa</p>
            <div id="syncStatus" class="sync-status">
                üîÑ Sincroniza√ß√£o Autom√°tica Ativa
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('recognition')">üì∑ Reconhecimento</button>
            <button class="tab" onclick="showTab('register')">‚ûï Cadastrar Pessoa</button>
            <button class="tab" onclick="showTab('list')">üìã Lista de Presen√ßa</button>
            <button class="tab" onclick="showTab('invite')">üìß Convites</button>
            <button class="tab" onclick="showTab('sync')">‚òÅÔ∏è Sincroniza√ß√£o</button>
        </div>
        
        <div class="content">
            <!-- Aba de Reconhecimento -->
            <div id="recognition" class="tab-content active">
                <h2>Reconhecimento Facial</h2>
                <div class="camera-container">
                    <video id="video" autoplay muted></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>
                <div class="controls">
                    <button class="btn" onclick="startCamera()">üì∑ Iniciar C√¢mera</button>
                    <button class="btn" onclick="stopCamera()">‚èπÔ∏è Parar C√¢mera</button>
                    <button class="btn" onclick="recognizeFace()" id="recognizeBtn" disabled>üîç Reconhecer Rosto</button>
                </div>
                <div id="recognitionResult"></div>
            </div>
            
            <!-- Aba de Cadastro -->
            <div id="register" class="tab-content">
                <h2>Cadastrar Nova Pessoa</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="fullName">Nome Completo:</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Telefone:</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="camera-container">
                        <video id="registerVideo" autoplay muted style="display: none;"></video>
                        <canvas id="registerCanvas" style="display: none;"></canvas>
                        <div id="photoPreview"></div>
                    </div>
                    <div class="controls">
                        <button type="button" class="btn" onclick="startRegisterCamera()">üì∑ Tirar Foto</button>
                        <button type="button" class="btn" onclick="capturePhoto()" id="captureBtn" disabled>üì∏ Capturar</button>
                        <button type="submit" class="btn" id="saveBtn" disabled>üíæ Salvar Pessoa</button>
                    </div>
                </form>
            </div>
            
            <!-- Aba de Lista -->
            <div id="list" class="tab-content">
                <h2>Lista de Presen√ßa</h2>
                
                <div class="attendance-summary" style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">üìä Resumo da Presen√ßa</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="presentCount">0</div>
                            <div style="color: #666;">‚úÖ Presentes</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="absentCount">0</div>
                            <div style="color: #666;">‚ùå Ausentes</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="facialOnlyCount">0</div>
                            <div style="color: #666;">ü§ñ S√≥ Facial</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;" id="confirmedCount">0</div>
                            <div style="color: #666;">‚úÖ‚úÖ Confirmados</div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="exportAttendance()">üìä Exportar Lista</button>
                    <button class="btn" onclick="exportBackup()">üíæ Fazer Backup</button>
                    <button class="btn" onclick="generateTemplate()">üìã Gerar Planilha Modelo</button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">üì• Importar Planilha</button>
                    <button class="btn" onclick="clearAttendance()">üîÑ Limpar Presen√ßas</button>
                    <button class="btn" onclick="markAllPresent()" style="background: #28a745;">‚úÖ Marcar Todos Presentes</button>
                    <button class="btn" onclick="confirmAllFacial()" style="background: #17a2b8;">‚úÖ‚úÖ Confirmar Todos Faciais</button>
                </div>
                <input type="file" id="importFile" accept=".csv,.xlsx,.xls,.json" style="display: none;" onchange="importFromFile(event)">
                <div id="personList" class="person-list"></div>
            </div>
            
            <!-- Aba de Convites -->
            <div id="invite" class="tab-content">
                <h2>Sistema de Convites</h2>
                <div class="invite-section">
                    <h3>Link de Convite</h3>
                    <p>Compartilhe este link para que as pessoas se cadastrem:</p>
                    <div class="invite-link" id="inviteLink"></div>
                    <button class="btn" onclick="copyInviteLink()">üìã Copiar Link</button>
                </div>
                
                <div id="notifications" style="margin-top: 30px;">
                    <h3>üì¨ Notifica√ß√µes</h3>
                    <div id="notificationsList"></div>
                </div>
                
                <div id="pendingInvites" style="margin-top: 30px;">
                    <h3>üìã Cadastros Pendentes</h3>
                    <div class="controls">
                        <button class="btn" onclick="updateInvitesList()">üîÑ Atualizar Lista</button>
                    </div>
                    <div id="invitesList"></div>
                </div>
            </div>
            
            <!-- Nova Aba de Sincroniza√ß√£o -->
            <div id="sync" class="tab-content">
                <h2>‚òÅÔ∏è Sincroniza√ß√£o Autom√°tica</h2>
                
                <div class="sync-section">
                    <h3>üîÑ Status da Sincroniza√ß√£o</h3>
                    <div id="syncInfo">
                        <p><strong>Status:</strong> <span id="syncStatusText">Ativo</span></p>
                        <p><strong>√öltima sincroniza√ß√£o:</strong> <span id="lastSyncText">Agora</span></p>
                        <p><strong>Pr√≥xima sincroniza√ß√£o:</strong> <span id="nextSyncText">Em 30 segundos</span></p>
                        <p><strong>Dados sincronizados:</strong> <span id="syncDataCount">0</span> registros</p>
                    </div>
                    
                    <div class="controls">
                        <button class="btn" onclick="toggleAutoSync()" id="syncToggleBtn">‚è∏Ô∏è Pausar Sincroniza√ß√£o</button>
                        <button class="btn" onclick="forcSync()">üîÑ Sincronizar Agora</button>
                        <button class="btn" onclick="resetSyncData()">üóëÔ∏è Limpar Dados Sincronizados</button>
                    </div>
                </div>
                
                <div class="sync-section">
                    <h3>üíæ Armazenamento Integrado no HTML</h3>
                    <p>Todos os dados s√£o automaticamente salvos no pr√≥prio arquivo HTML. Voc√™ pode:</p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>‚úÖ Salvar o arquivo HTML e levar para qualquer computador</li>
                        <li>‚úÖ Abrir em qualquer navegador com todos os dados</li>
                        <li>‚úÖ Compartilhar o arquivo completo com outras pessoas</li>
                        <li>‚úÖ Fazer backup simplesmente copiando o arquivo</li>
                    </ul>
                    
                    <div class="controls">
                        <button class="btn" onclick="downloadHTMLWithData()">üíæ Baixar HTML com Dados</button>
                        <button class="btn" onclick="showDataPreview()">üëÅÔ∏è Visualizar Dados Salvos</button>
                    </div>
                    
                    <div id="dataPreview" class="data-storage" style="display: none;">
                        <h4>üìä Dados Armazenados no HTML:</h4>
                        <div id="dataContent"></div>
                    </div>
                </div>
                
                <div class="sync-section">
                    <h3>üåê Sincroniza√ß√£o Entre Dispositivos</h3>
                    <p>Para usar os mesmos dados em v√°rios dispositivos:</p>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4>üì± M√©todo 1: Arquivo HTML Port√°til</h4>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Clique em "Baixar HTML com Dados"</li>
                            <li>Salve na nuvem (Google Drive, OneDrive, etc.)</li>
                            <li>Baixe e abra em qualquer dispositivo</li>
                        </ol>
                    </div>
                    
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4>‚òÅÔ∏è M√©todo 2: Sincroniza√ß√£o Autom√°tica</h4>
                        <p>Cole o c√≥digo de sincroniza√ß√£o para conectar dispositivos:</p>
                        <input type="text" id="syncCode" placeholder="Cole o c√≥digo aqui..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
                        <div class="controls">
                            <button class="btn" onclick="generateSyncCode()">üîó Gerar C√≥digo</button>
                            <button class="btn" onclick="connectWithCode()">üîå Conectar com C√≥digo</button>
                        </div>
                        <div id="generatedCode" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Armazenamento de dados integrado no HTML -->
    <script id="dataStorage" type="application/json">
    {
        "people": [],
        "attendance": {},
        "invites": [],
        "notifications": [],
        "settings": {
            "autoSync": true,
            "syncInterval": 30000,
            "lastSync": null
        }
    }
    </script>

    <script>
        // Vari√°veis globais
        let video = null;
        let canvas = null;
        let ctx = null;
        let model = null;
        let stream = null;
        
        // Sistema de sincroniza√ß√£o autom√°tica
        let syncEnabled = true;
        let syncInterval = null;
        let syncCode = null;
        
        // Carregar dados do HTML integrado
        function loadDataFromHTML() {
            try {
                const dataScript = document.getElementById('dataStorage');
                const data = JSON.parse(dataScript.textContent);
                return data;
            } catch (error) {
                console.log('Criando estrutura de dados inicial');
                return {
                    people: [],
                    attendance: {},
                    invites: [],
                    notifications: [],
                    settings: {
                        autoSync: true,
                        syncInterval: 30000,
                        lastSync: null
                    }
                };
            }
        }
        
        // Salvar dados no HTML integrado
        function saveDataToHTML() {
            const data = {
                people: people,
                attendance: attendance,
                invites: invites,
                notifications: JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]'),
                settings: {
                    autoSync: syncEnabled,
                    syncInterval: 30000,
                    lastSync: new Date().toISOString()
                }
            };
            
            const dataScript = document.getElementById('dataStorage');
            dataScript.textContent = JSON.stringify(data, null, 2);
            
            // Tamb√©m manter no localStorage para compatibilidade
            localStorage.setItem('faceRecognitionPeople', JSON.stringify(people));
            localStorage.setItem('faceRecognitionAttendance', JSON.stringify(attendance));
            localStorage.setItem('faceRecognitionInvites', JSON.stringify(invites));
            
            updateSyncStatus();
        }
        
        // Carregar dados iniciais
        let htmlData = loadDataFromHTML();
        let people = htmlData.people || JSON.parse(localStorage.getItem('faceRecognitionPeople') || '[]');
        let attendance = htmlData.attendance || JSON.parse(localStorage.getItem('faceRecognitionAttendance') || '{}');
        let invites = htmlData.invites || JSON.parse(localStorage.getItem('faceRecognitionInvites') || '[]');

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadModel();
            updatePersonList();
            generateInviteLink();
            checkForInviteRegistration();
            updateNotifications();
            updateInvitesList();
            startAutoSync();
            updateSyncStatus();
        });

        // Sistema de sincroniza√ß√£o autom√°tica
        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                if (syncEnabled) {
                    saveDataToHTML();
                    updateSyncStatus();
                }
            }, 30000); // Sincronizar a cada 30 segundos
        }
        
        function toggleAutoSync() {
            syncEnabled = !syncEnabled;
            const btn = document.getElementById('syncToggleBtn');
            
            if (syncEnabled) {
                btn.innerHTML = '‚è∏Ô∏è Pausar Sincroniza√ß√£o';
                btn.style.background = '#dc3545';
                startAutoSync();
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è Ativar Sincroniza√ß√£o';
                btn.style.background = '#28a745';
                if (syncInterval) clearInterval(syncInterval);
            }
            
            updateSyncStatus();
        }
        
        function forcSync() {
            saveDataToHTML();
            updateSyncStatus();
            
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.className = 'sync-status syncing';
            statusDiv.innerHTML = 'üîÑ Sincronizando...';
            
            setTimeout(() => {
                statusDiv.className = 'sync-status synced';
                statusDiv.innerHTML = '‚úÖ Sincronizado';
                
                setTimeout(() => {
                    statusDiv.className = 'sync-status';
                    statusDiv.innerHTML = 'üîÑ Sincroniza√ß√£o Autom√°tica Ativa';
                }, 2000);
            }, 1000);
        }
        
        function updateSyncStatus() {
            const now = new Date();
            const totalRecords = people.length + Object.keys(attendance).length + invites.length;
            
            document.getElementById('syncStatusText').textContent = syncEnabled ? 'Ativo' : 'Pausado';
            document.getElementById('lastSyncText').textContent = now.toLocaleString('pt-BR');
            document.getElementById('nextSyncText').textContent = syncEnabled ? 'Em 30 segundos' : 'Pausado';
            document.getElementById('syncDataCount').textContent = totalRecords;
        }
        
        function resetSyncData() {
            if (confirm('‚ö†Ô∏è Isso ir√° apagar TODOS os dados salvos. Tem certeza?')) {
                people = [];
                attendance = {};
                invites = [];
                localStorage.clear();
                
                const dataScript = document.getElementById('dataStorage');
                dataScript.textContent = JSON.stringify({
                    people: [],
                    attendance: {},
                    invites: [],
                    notifications: [],
                    settings: { autoSync: true, syncInterval: 30000, lastSync: null }
                }, null, 2);
                
                updatePersonList();
                updateInvitesList();
                updateNotifications();
                updateSyncStatus();
                
                alert('‚úÖ Todos os dados foram limpos!');
            }
        }
        
        // Baixar HTML com dados integrados
        function downloadHTMLWithData() {
            // For√ßar sincroniza√ß√£o antes do download
            saveDataToHTML();
            
            // Obter o HTML completo da p√°gina
            const htmlContent = document.documentElement.outerHTML;
            
            // Criar arquivo para download
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema_presenca_completo_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert(`‚úÖ HTML PORT√ÅTIL GERADO!

üìÅ Arquivo: sistema_presenca_completo_${new Date().toISOString().split('T')[0]}.html

üéØ COMO USAR:
‚Ä¢ Abra o arquivo em qualquer navegador
‚Ä¢ Todos os dados estar√£o l√° automaticamente
‚Ä¢ Funciona offline, sem internet
‚Ä¢ Compartilhe com outras pessoas
‚Ä¢ Salve na nuvem para backup

üíæ DADOS INCLUSOS:
‚Ä¢ ${people.length} pessoas cadastradas
‚Ä¢ ${Object.keys(attendance).length} registros de presen√ßa
‚Ä¢ ${invites.length} convites
‚Ä¢ Todas as configura√ß√µes`);
        }
        
        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            const content = document.getElementById('dataContent');
            
            if (preview.style.display === 'none') {
                const data = loadDataFromHTML();
                content.innerHTML = `
                    <strong>üë• Pessoas:</strong> ${data.people.length} cadastradas<br>
                    <strong>üìã Presen√ßas:</strong> ${Object.keys(data.attendance).length} registros<br>
                    <strong>üìß Convites:</strong> ${data.invites.length} pendentes<br>
                    <strong>üîî Notifica√ß√µes:</strong> ${data.notifications.length} mensagens<br>
                    <strong>‚öôÔ∏è Configura√ß√µes:</strong> Sincroniza√ß√£o ${data.settings.autoSync ? 'ativa' : 'pausada'}<br><br>
                    <strong>üìä Dados completos:</strong><br>
                    <pre style="font-size: 10px; max-height: 150px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                `;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Sistema de c√≥digos de sincroniza√ß√£o
        function generateSyncCode() {
            const data = {
                people: people,
                attendance: attendance,
                invites: invites,
                timestamp: Date.now()
            };
            
            // Gerar c√≥digo base64 comprimido
            const jsonString = JSON.stringify(data);
            syncCode = btoa(jsonString).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
            
            // Salvar dados com o c√≥digo
            localStorage.setItem(`syncData_${syncCode}`, jsonString);
            
            document.getElementById('generatedCode').innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>üîó C√≥digo de Sincroniza√ß√£o Gerado:</h4>
                    <div style="font-family: monospace; font-size: 18px; font-weight: bold; color: #155724; text-align: center; padding: 10px; background: white; border-radius: 5px; margin: 10px 0;">
                        ${syncCode}
                    </div>
                    <p><strong>üìã Como usar:</strong></p>
                    <ol>
                        <li>Copie este c√≥digo</li>
                        <li>Abra o sistema em outro dispositivo</li>
                        <li>V√° na aba "Sincroniza√ß√£o"</li>
                        <li>Cole o c√≥digo e clique "Conectar"</li>
                    </ol>
                    <button class="btn" onclick="navigator.clipboard.writeText('${syncCode}')">üìã Copiar C√≥digo</button>
                </div>
            `;
        }
        
        function connectWithCode() {
            const code = document.getElementById('syncCode').value.trim();
            if (!code) {
                alert('Por favor, digite um c√≥digo de sincroniza√ß√£o.');
                return;
            }
            
            try {
                const syncData = localStorage.getItem(`syncData_${code}`);
                if (!syncData) {
                    alert('‚ùå C√≥digo n√£o encontrado. Verifique se est√° correto.');
                    return;
                }
                
                const data = JSON.parse(syncData);
                const confirmMessage = `
üîó CONECTAR COM C√ìDIGO: ${code}

Dados encontrados:
‚Ä¢ ${data.people.length} pessoas
‚Ä¢ ${Object.keys(data.attendance).length} presen√ßas
‚Ä¢ ${data.invites.length} convites
‚Ä¢ Data: ${new Date(data.timestamp).toLocaleString('pt-BR')}

‚ö†Ô∏è Seus dados atuais ser√£o substitu√≠dos!
Deseja continuar?`;
                
                if (confirm(confirmMessage)) {
                    people = data.people;
                    attendance = data.attendance;
                    invites = data.invites;
                    
                    saveDataToHTML();
                    updatePersonList();
                    updateInvitesList();
                    updateNotifications();
                    
                    alert('‚úÖ Sincroniza√ß√£o realizada com sucesso!');
                    document.getElementById('syncCode').value = '';
                }
            } catch (error) {
                alert('‚ùå Erro ao conectar: ' + error.message);
            }
        }

        // Carregar modelo de reconhecimento facial
        async function loadModel() {
            try {
                model = await blazeface.load();
                console.log('Modelo carregado com sucesso');
            } catch (error) {
                console.error('Erro ao carregar modelo:', error);
            }
        }

        // Gerenciamento de abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Parar c√¢mera se mudou de aba
            if (tabName !== 'recognition' && tabName !== 'register') {
                stopCamera();
                stopRegisterCamera();
            }
        }

        // Fun√ß√µes da c√¢mera principal
        async function startCamera() {
            try {
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('recognizeBtn').disabled = false;
                };
            } catch (error) {
                alert('Erro ao acessar c√¢mera: ' + error.message);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video) {
                video.srcObject = null;
            }
            document.getElementById('recognizeBtn').disabled = true;
        }

        // Reconhecimento facial
        async function recognizeFace() {
            if (!model || !video) {
                alert('Modelo n√£o carregado ou c√¢mera n√£o iniciada');
                return;
            }

            const resultDiv = document.getElementById('recognitionResult');
            resultDiv.innerHTML = '<div style="text-align: center;">üîç Analisando rosto...</div>';

            try {
                // Capturar frame atual
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);

                // Detectar rosto
                const predictions = await model.estimateFaces(canvas, false);
                
                if (predictions.length === 0) {
                    resultDiv.innerHTML = '<div class="recognition-result error">‚ùå Nenhum rosto detectado. Posicione-se melhor na c√¢mera.</div>';
                    return;
                }

                // Simular reconhecimento (compara√ß√£o b√°sica com rostos cadastrados)
                const recognizedPerson = await findMatchingPerson(imageData);
                
                if (recognizedPerson) {
                    // Marcar presen√ßa por reconhecimento facial
                    attendance[recognizedPerson.email] = {
                        name: recognizedPerson.fullName,
                        time: new Date().toLocaleString('pt-BR'),
                        present: true,
                        method: 'facial',
                        confirmed: false
                    };
                    
                    saveDataToHTML(); // Sincronizar automaticamente
                    
                    resultDiv.innerHTML = `
                        <div class="recognition-result success">
                            ‚úÖ Bem-vindo(a), ${recognizedPerson.fullName}!<br>
                            Presen√ßa registrada √†s ${new Date().toLocaleTimeString('pt-BR')}
                        </div>
                    `;
                    
                    updatePersonList();
                } else {
                    resultDiv.innerHTML = '<div class="recognition-result error">‚ùå Pessoa n√£o reconhecida. Verifique se est√° cadastrada no sistema.</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="recognition-result error">‚ùå Erro no reconhecimento: ' + error.message + '</div>';
            }
        }

        // Fun√ß√£o para encontrar pessoa correspondente (simula√ß√£o)
        async function findMatchingPerson(imageData) {
            // Esta √© uma simula√ß√£o. Em um sistema real, usar√≠amos algoritmos de compara√ß√£o facial
            // Por enquanto, vamos usar uma l√≥gica simples baseada no tempo de cadastro
            if (people.length === 0) return null;
            
            // Simular reconhecimento retornando uma pessoa aleat√≥ria para demonstra√ß√£o
            // Em produ√ß√£o, isso seria substitu√≠do por compara√ß√£o real de caracter√≠sticas faciais
            const randomIndex = Math.floor(Math.random() * people.length);
            return people[randomIndex];
        }

        // Fun√ß√µes da c√¢mera de cadastro
        let registerVideo = null;
        let registerCanvas = null;
        let registerStream = null;
        let capturedPhoto = null;

        async function startRegisterCamera() {
            try {
                registerVideo = document.getElementById('registerVideo');
                registerCanvas = document.getElementById('registerCanvas');
                
                registerStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                registerVideo.srcObject = registerStream;
                registerVideo.style.display = 'block';
                
                registerVideo.onloadedmetadata = () => {
                    registerCanvas.width = registerVideo.videoWidth;
                    registerCanvas.height = registerVideo.videoHeight;
                    document.getElementById('captureBtn').disabled = false;
                };
            } catch (error) {
                alert('Erro ao acessar c√¢mera: ' + error.message);
            }
        }

        function stopRegisterCamera() {
            if (registerStream) {
                registerStream.getTracks().forEach(track => track.stop());
                registerStream = null;
            }
            if (registerVideo) {
                registerVideo.srcObject = null;
                registerVideo.style.display = 'none';
            }
            document.getElementById('captureBtn').disabled = true;
        }

        function capturePhoto() {
            if (!registerVideo) return;
            
            const ctx = registerCanvas.getContext('2d');
            ctx.drawImage(registerVideo, 0, 0, registerCanvas.width, registerCanvas.height);
            capturedPhoto = registerCanvas.toDataURL('image/jpeg', 0.8);
            
            // Mostrar preview
            document.getElementById('photoPreview').innerHTML = `
                <img src="${capturedPhoto}" style="max-width: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <p style="margin-top: 10px; color: #28a745; font-weight: bold;">‚úÖ Foto capturada com sucesso!</p>
            `;
            
            document.getElementById('saveBtn').disabled = false;
            stopRegisterCamera();
        }

        // Cadastro de pessoa
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            
            if (!capturedPhoto) {
                alert('Por favor, capture uma foto antes de salvar.');
                return;
            }
            
            // Verificar se email j√° existe
            if (people.find(p => p.email === email)) {
                alert('Este email j√° est√° cadastrado.');
                return;
            }
            
            const newPerson = {
                id: Date.now(),
                fullName,
                email,
                phone,
                photo: capturedPhoto,
                registeredAt: new Date().toLocaleString('pt-BR')
            };
            
            people.push(newPerson);
            saveDataToHTML(); // Sincronizar automaticamente
            
            // Limpar formul√°rio
            document.getElementById('registerForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            capturedPhoto = null;
            document.getElementById('saveBtn').disabled = true;
            
            alert('Pessoa cadastrada com sucesso!');
            updatePersonList();
        });

        // Atualizar lista de pessoas
        function updatePersonList() {
            const listDiv = document.getElementById('personList');
            
            if (people.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; font-size: 18px;">Nenhuma pessoa cadastrada ainda.</p>';
                updateAttendanceSummary();
                return;
            }
            
            listDiv.innerHTML = people.map(person => {
                const attendanceData = attendance[person.email];
                const isPresent = attendanceData?.present || false;
                const method = attendanceData?.method || '';
                const confirmed = attendanceData?.confirmed || false;
                const attendanceTime = attendanceData?.time || '';
                
                // Determinar status e classe CSS
                let statusClass = 'absent';
                let statusText = '‚ùå Ausente';
                let cardClass = '';
                
                if (isPresent) {
                    if (method === 'facial' && !confirmed) {
                        statusClass = 'facial-only';
                        statusText = 'ü§ñ Reconhecido (Facial)';
                        cardClass = 'facial-only';
                    } else if (method === 'manual' || confirmed) {
                        statusClass = 'confirmed';
                        statusText = confirmed ? '‚úÖ‚úÖ Confirmado' : '‚úÖ Presente (Manual)';
                        cardClass = 'confirmed';
                    } else {
                        statusClass = 'present';
                        statusText = '‚úÖ Presente';
                        cardClass = 'present';
                    }
                }
                
                return `
                    <div class="person-card ${cardClass}">
                        <div class="person-info">
                            <h3>${person.fullName}</h3>
                            <p><strong>Email:</strong> ${person.email}</p>
                            <p><strong>Telefone:</strong> ${person.phone}</p>
                            <p><strong>Cadastrado em:</strong> ${person.registeredAt}</p>
                            ${isPresent ? `<p><strong>Presente desde:</strong> ${attendanceTime}</p>` : ''}
                            ${method ? `<p><strong>M√©todo:</strong> ${method === 'facial' ? 'ü§ñ Reconhecimento Facial' : '‚úÖ Marca√ß√£o Manual'}</p>` : ''}
                            
                            <span class="status ${statusClass}">
                                ${statusText}
                            </span>
                            
                            <!-- Controles de Presen√ßa -->
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #555;">üìã Controle de Presen√ßa:</h4>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="manual_${person.email}" 
                                           ${isPresent && method === 'manual' ? 'checked' : ''} 
                                           onchange="toggleManualAttendance('${person.email}')">
                                    <label for="manual_${person.email}">‚úÖ Marcar Presente Manualmente</label>
                                </div>
                                
                                ${method === 'facial' && !confirmed ? `
                                    <div class="checkbox-container" style="background: rgba(255, 193, 7, 0.2);">
                                        <input type="checkbox" id="confirm_${person.email}" 
                                               onchange="confirmFacialAttendance('${person.email}')">
                                        <label for="confirm_${person.email}">‚úÖ‚úÖ Confirmar Reconhecimento Facial</label>
                                    </div>
                                ` : ''}
                                
                                ${isPresent ? `
                                    <button class="btn" onclick="removeAttendance('${person.email}')" 
                                            style="background: #dc3545; font-size: 14px; padding: 8px 16px;">
                                        ‚ùå Remover Presen√ßa
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="removePerson('${person.email}')" style="background: #dc3545;">üóëÔ∏è Remover Pessoa</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateAttendanceSummary();
        }

        // Remover pessoa
        function removePerson(email) {
            if (confirm('Tem certeza que deseja remover esta pessoa?')) {
                people = people.filter(p => p.email !== email);
                delete attendance[email];
                
                saveDataToHTML(); // Sincronizar automaticamente
                updatePersonList();
            }
        }

        // Exportar lista de presen√ßa
        function exportAttendance() {
            const attendanceData = people.map(person => {
                const attendanceInfo = attendance[person.email];
                const isPresent = attendanceInfo?.present || false;
                const method = attendanceInfo?.method || '';
                const confirmed = attendanceInfo?.confirmed || false;
                
                let status = 'Ausente';
                if (isPresent) {
                    if (method === 'facial' && !confirmed) {
                        status = 'Reconhecido (N√£o Confirmado)';
                    } else if (method === 'facial' && confirmed) {
                        status = 'Reconhecido e Confirmado';
                    } else if (method === 'manual') {
                        status = 'Presente (Manual)';
                    } else {
                        status = 'Presente';
                    }
                }
                
                return {
                    nome: person.fullName,
                    email: person.email,
                    telefone: person.phone,
                    status: status,
                    metodo: method === 'facial' ? 'Reconhecimento Facial' : method === 'manual' ? 'Marca√ß√£o Manual' : 'N/A',
                    confirmado: confirmed ? 'Sim' : 'N√£o',
                    horario: attendanceInfo?.time || 'N/A',
                    confirmadoEm: attendanceInfo?.confirmedAt || 'N/A'
                };
            });
            
            const csv = [
                ['Nome', 'Email', 'Telefone', 'Status', 'M√©todo', 'Confirmado', 'Hor√°rio Presen√ßa', 'Hor√°rio Confirma√ß√£o'],
                ...attendanceData.map(row => [
                    row.nome, row.email, row.telefone, row.status, 
                    row.metodo, row.confirmado, row.horario, row.confirmadoEm
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lista_presenca_detalhada_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Mostrar resumo da exporta√ß√£o
            const summary = {
                total: people.length,
                ausentes: attendanceData.filter(p => p.status === 'Ausente').length,
                reconhecidos: attendanceData.filter(p => p.status.includes('Reconhecido')).length,
                manuais: attendanceData.filter(p => p.status.includes('Manual')).length,
                confirmados: attendanceData.filter(p => p.confirmado === 'Sim').length
            };
            
            alert(`üìä LISTA EXPORTADA COM SUCESSO!

üìÅ Arquivo: lista_presenca_detalhada_${new Date().toISOString().split('T')[0]}.csv

üìà RESUMO:
‚Ä¢ Total de pessoas: ${summary.total}
‚Ä¢ Ausentes: ${summary.ausentes}
‚Ä¢ Reconhecidos facialmente: ${summary.reconhecidos}
‚Ä¢ Marcados manualmente: ${summary.manuais}
‚Ä¢ Confirmados: ${summary.confirmados}

‚ú® NOVOS CAMPOS INCLUSOS:
‚Ä¢ Status detalhado da presen√ßa
‚Ä¢ M√©todo de marca√ß√£o (Facial/Manual)
‚Ä¢ Se foi confirmado ou n√£o
‚Ä¢ Hor√°rio da confirma√ß√£o`);
        }

        // Fazer backup completo do sistema
        function exportBackup() {
            const backupData = {
                people: people,
                attendance: attendance,
                invites: invites,
                notifications: JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]'),
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const json = JSON.stringify(backupData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_sistema_presenca_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup realizado com sucesso! Arquivo salvo com todos os dados do sistema.');
        }

        // Gerar planilha modelo para preenchimento
        function generateTemplate() {
            // Criar planilha modelo com exemplos
            const templateData = [
                ['Nome', 'Email', 'Telefone'],
                ['Jo√£o Silva', 'joao.silva@email.com', '11999999999'],
                ['Maria Santos', 'maria.santos@email.com', '11888888888'],
                ['Pedro Oliveira', 'pedro.oliveira@email.com', '11777777777'],
                ['Ana Costa', 'ana.costa@email.com', '11666666666'],
                ['Carlos Ferreira', 'carlos.ferreira@email.com', '11555555555'],
                ['', '', ''],
                ['', '', ''],
                ['', '', ''],
                ['', '', ''],
                ['', '', '']
            ];
            
            // Converter para CSV
            const csv = templateData.map(row => row.join(',')).join('\n');
            
            // Criar arquivo para download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modelo_cadastro_pessoas_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Mostrar instru√ß√µes
            alert(`üìã PLANILHA MODELO GERADA!

‚úÖ Arquivo baixado: modelo_cadastro_pessoas_${new Date().toISOString().split('T')[0]}.csv

üìù COMO USAR:
1. Abra o arquivo no Excel, Google Sheets ou LibreOffice
2. Substitua os dados de exemplo pelos dados reais
3. Mantenha o cabe√ßalho (Nome, Email, Telefone)
4. Preencha uma pessoa por linha
5. Salve como CSV
6. Use o bot√£o "üì• Importar Planilha" para carregar no sistema

‚ö†Ô∏è IMPORTANTE:
‚Ä¢ Nome e Email s√£o obrigat√≥rios
‚Ä¢ Telefone √© opcional
‚Ä¢ N√£o altere o cabe√ßalho da planilha
‚Ä¢ Emails devem ser √∫nicos (n√£o repetir)`);
        }

        // Importar dados de planilha ou backup
        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        // Importar backup completo
                        importBackup(content);
                    } else if (file.name.endsWith('.csv')) {
                        // Importar planilha CSV
                        importCSV(content);
                    } else {
                        alert('‚ùå Formato de arquivo n√£o suportado. Use apenas .csv ou .json');
                    }
                } catch (error) {
                    alert('‚ùå Erro ao ler arquivo: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Limpar input
        }

        // Importar backup completo
        function importBackup(jsonContent) {
            try {
                const backupData = JSON.parse(jsonContent);
                
                if (!backupData.people || !Array.isArray(backupData.people)) {
                    throw new Error('Arquivo de backup inv√°lido');
                }
                
                const confirmMessage = `
üîÑ RESTAURAR BACKUP

Dados encontrados:
‚Ä¢ ${backupData.people.length} pessoas cadastradas
‚Ä¢ ${Object.keys(backupData.attendance || {}).length} registros de presen√ßa
‚Ä¢ ${(backupData.invites || []).length} convites
‚Ä¢ Data do backup: ${new Date(backupData.exportDate).toLocaleString('pt-BR')}

‚ö†Ô∏è ATEN√á√ÉO: Todos os dados atuais ser√£o substitu√≠dos!

Deseja continuar?`;
                
                if (confirm(confirmMessage)) {
                    // Restaurar dados
                    people = backupData.people;
                    attendance = backupData.attendance || {};
                    invites = backupData.invites || [];
                    
                    saveDataToHTML(); // Sincronizar automaticamente
                    
                    if (backupData.notifications) {
                        localStorage.setItem('faceRecognitionNotifications', JSON.stringify(backupData.notifications));
                    }
                    
                    // Atualizar interface
                    updatePersonList();
                    updateInvitesList();
                    updateNotifications();
                    
                    alert('‚úÖ Backup restaurado com sucesso!');
                }
            } catch (error) {
                alert('‚ùå Erro ao importar backup: ' + error.message);
            }
        }

        // Importar planilha CSV
        function importCSV(csvContent) {
            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('Planilha deve ter pelo menos um cabe√ßalho e uma linha de dados');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const requiredFields = ['nome', 'email'];
                
                // Verificar se tem campos obrigat√≥rios
                const hasRequiredFields = requiredFields.every(field => 
                    headers.some(header => header.includes(field))
                );
                
                if (!hasRequiredFields) {
                    throw new Error('Planilha deve conter pelo menos as colunas: Nome, Email');
                }
                
                const newPeople = [];
                const errors = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    if (values.length < headers.length) continue;
                    
                    const person = {};
                    headers.forEach((header, index) => {
                        if (header.includes('nome')) person.fullName = values[index];
                        else if (header.includes('email')) person.email = values[index];
                        else if (header.includes('telefone') || header.includes('phone')) person.phone = values[index];
                    });
                    
                    // Validar dados obrigat√≥rios
                    if (!person.fullName || !person.email) {
                        errors.push(`Linha ${i + 1}: Nome ou email em branco`);
                        continue;
                    }
                    
                    // Verificar se email j√° existe
                    if (people.find(p => p.email === person.email)) {
                        errors.push(`Linha ${i + 1}: Email ${person.email} j√° cadastrado`);
                        continue;
                    }
                    
                    // Adicionar campos padr√£o
                    person.id = Date.now() + i;
                    person.phone = person.phone || '';
                    person.photo = null;
                    person.registeredAt = new Date().toLocaleString('pt-BR');
                    person.fromImport = true;
                    
                    newPeople.push(person);
                }
                
                if (newPeople.length === 0) {
                    throw new Error('Nenhuma pessoa v√°lida encontrada na planilha');
                }
                
                // Mostrar resumo da importa√ß√£o
                let message = `üìä IMPORTA√á√ÉO DE PLANILHA\n\n`;
                message += `‚úÖ ${newPeople.length} pessoas ser√£o adicionadas\n`;
                if (errors.length > 0) {
                    message += `‚ö†Ô∏è ${errors.length} erros encontrados:\n`;
                    message += errors.slice(0, 5).join('\n');
                    if (errors.length > 5) {
                        message += `\n... e mais ${errors.length - 5} erros`;
                    }
                    message += '\n\n';
                }
                message += 'Deseja continuar com a importa√ß√£o?';
                
                if (confirm(message)) {
                    // Adicionar pessoas √† lista
                    people.push(...newPeople);
                    saveDataToHTML(); // Sincronizar automaticamente
                    
                    updatePersonList();
                    
                    alert(`‚úÖ Importa√ß√£o conclu√≠da!\n\n‚Ä¢ ${newPeople.length} pessoas adicionadas\n‚Ä¢ ${errors.length} erros ignorados`);
                }
                
            } catch (error) {
                alert('‚ùå Erro ao importar planilha: ' + error.message + '\n\nFormato esperado:\nNome,Email,Telefone\nJo√£o Silva,joao@email.com,11999999999');
            }
        }

        // Atualizar resumo de presen√ßa
        function updateAttendanceSummary() {
            let presentCount = 0;
            let absentCount = 0;
            let facialOnlyCount = 0;
            let confirmedCount = 0;
            
            people.forEach(person => {
                const attendanceData = attendance[person.email];
                const isPresent = attendanceData?.present || false;
                const method = attendanceData?.method || '';
                const confirmed = attendanceData?.confirmed || false;
                
                if (!isPresent) {
                    absentCount++;
                } else if (method === 'facial' && !confirmed) {
                    facialOnlyCount++;
                } else if (confirmed || method === 'manual') {
                    confirmedCount++;
                } else {
                    presentCount++;
                }
            });
            
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('facialOnlyCount').textContent = facialOnlyCount;
            document.getElementById('confirmedCount').textContent = confirmedCount;
        }
        
        // Marcar presen√ßa manual
        function toggleManualAttendance(email) {
            const checkbox = document.getElementById(`manual_${email}`);
            const person = people.find(p => p.email === email);
            
            if (checkbox.checked) {
                attendance[email] = {
                    name: person.fullName,
                    time: new Date().toLocaleString('pt-BR'),
                    present: true,
                    method: 'manual',
                    confirmed: true
                };
            } else {
                delete attendance[email];
            }
            
            saveDataToHTML();
            updatePersonList();
        }
        
        // Confirmar reconhecimento facial
        function confirmFacialAttendance(email) {
            if (attendance[email] && attendance[email].method === 'facial') {
                attendance[email].confirmed = true;
                attendance[email].confirmedAt = new Date().toLocaleString('pt-BR');
                
                saveDataToHTML();
                updatePersonList();
            }
        }
        
        // Remover presen√ßa espec√≠fica
        function removeAttendance(email) {
            if (confirm('Remover a presen√ßa desta pessoa?')) {
                delete attendance[email];
                saveDataToHTML();
                updatePersonList();
            }
        }
        
        // Marcar todos como presentes
        function markAllPresent() {
            if (confirm('Marcar TODAS as pessoas como presentes manualmente?')) {
                people.forEach(person => {
                    attendance[person.email] = {
                        name: person.fullName,
                        time: new Date().toLocaleString('pt-BR'),
                        present: true,
                        method: 'manual',
                        confirmed: true
                    };
                });
                
                saveDataToHTML();
                updatePersonList();
                alert('‚úÖ Todas as pessoas foram marcadas como presentes!');
            }
        }
        
        // Confirmar todos os reconhecimentos faciais
        function confirmAllFacial() {
            let facialCount = 0;
            
            people.forEach(person => {
                const attendanceData = attendance[person.email];
                if (attendanceData && attendanceData.method === 'facial' && !attendanceData.confirmed) {
                    attendanceData.confirmed = true;
                    attendanceData.confirmedAt = new Date().toLocaleString('pt-BR');
                    facialCount++;
                }
            });
            
            if (facialCount > 0) {
                saveDataToHTML();
                updatePersonList();
                alert(`‚úÖ ${facialCount} reconhecimentos faciais foram confirmados!`);
            } else {
                alert('‚ÑπÔ∏è N√£o h√° reconhecimentos faciais pendentes de confirma√ß√£o.');
            }
        }
        
        // Limpar presen√ßas
        function clearAttendance() {
            if (confirm('Tem certeza que deseja limpar todas as presen√ßas?')) {
                attendance = {};
                saveDataToHTML(); // Sincronizar automaticamente
                updatePersonList();
            }
        }

        // Sistema de convites
        function generateInviteLink() {
            const baseUrl = window.location.origin + window.location.pathname;
            const inviteCode = btoa('invite_' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 10);
            const inviteUrl = `${baseUrl}?invite=${inviteCode}`;
            
            document.getElementById('inviteLink').textContent = inviteUrl;
            localStorage.setItem('faceRecognitionInviteCode', inviteCode);
        }

        function copyInviteLink() {
            const link = document.getElementById('inviteLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copiado para a √°rea de transfer√™ncia!');
            });
        }

        // Verificar se √© um acesso via convite
        function checkForInviteRegistration() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            
            if (inviteCode) {
                // Mostrar formul√°rio de auto-cadastro
                showInviteRegistrationForm();
            }
        }

        function showInviteRegistrationForm() {
            // Criar modal para auto-cadastro
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üìù Cadastro por Convite</h2>
                    <form id="inviteForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Completo:</label>
                            <input type="text" id="inviteFullName" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="inviteEmail" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone:</label>
                            <input type="tel" id="invitePhone" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px;">
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn">‚úÖ Confirmar Cadastro</button>
                            <button type="button" class="btn" onclick="closeInviteModal()" style="background: #6c757d; margin-left: 10px;">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.inviteModal = modal;
            
            // Adicionar evento ao formul√°rio
            document.getElementById('inviteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fullName = document.getElementById('inviteFullName').value;
                const email = document.getElementById('inviteEmail').value;
                const phone = document.getElementById('invitePhone').value;
                
                // Adicionar √† lista de convites pendentes
                const invite = {
                    id: Date.now(),
                    fullName,
                    email,
                    phone,
                    invitedAt: new Date().toLocaleString('pt-BR'),
                    status: 'pending'
                };
                
                invites.push(invite);
                saveDataToHTML(); // Sincronizar automaticamente
                
                // Enviar notifica√ß√£o por email
                sendEmailNotification(invite);
                
                alert('Cadastro realizado com sucesso! Uma notifica√ß√£o foi enviada ao administrador.');
                closeInviteModal();
            });
        }

        function closeInviteModal() {
            if (window.inviteModal) {
                document.body.removeChild(window.inviteModal);
                window.inviteModal = null;
            }
        }

        // Fun√ß√£o para enviar notifica√ß√£o por email
        function sendEmailNotification(invite) {
            const adminEmail = 'paulo.henrique72681@gmail.com';
            const subject = `Novo Cadastro no Sistema de Presen√ßa - ${invite.fullName}`;
            const body = `
Ol√°!

Uma nova pessoa se cadastrou no sistema de reconhecimento facial:

üìù DADOS DO CADASTRO:
‚Ä¢ Nome: ${invite.fullName}
‚Ä¢ Email: ${invite.email}
‚Ä¢ Telefone: ${invite.phone}
‚Ä¢ Data/Hora: ${invite.invitedAt}

üîó Para aprovar o cadastro, acesse o sistema e v√° na aba "Convites".

---
Sistema de Presen√ßa com Reconhecimento Facial
            `.trim();

            // Criar link mailto
            const mailtoLink = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Tentar abrir cliente de email
            try {
                window.open(mailtoLink, '_blank');
            } catch (error) {
                console.log('Email notification prepared for:', adminEmail);
            }

            // Tamb√©m salvar notifica√ß√£o no sistema para visualiza√ß√£o
            const notifications = JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]');
            notifications.push({
                id: Date.now(),
                type: 'new_registration',
                data: invite,
                timestamp: new Date().toLocaleString('pt-BR'),
                read: false
            });
            localStorage.setItem('faceRecognitionNotifications', JSON.stringify(notifications));
        }

        // Atualizar lista de notifica√ß√µes
        function updateNotifications() {
            const notifications = JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]');
            const notificationsDiv = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsDiv.innerHTML = '<p style="color: #666; text-align: center;">Nenhuma notifica√ß√£o ainda.</p>';
                return;
            }
            
            notificationsDiv.innerHTML = notifications.reverse().map(notification => `
                <div style="background: ${notification.read ? '#f8f9fa' : '#e3f2fd'}; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="color: #667eea; margin: 0 0 10px 0;">üìß Novo Cadastro Recebido</h4>
                            <p><strong>Nome:</strong> ${notification.data.fullName}</p>
                            <p><strong>Email:</strong> ${notification.data.email}</p>
                            <p><strong>Telefone:</strong> ${notification.data.phone}</p>
                            <p><strong>Data:</strong> ${notification.timestamp}</p>
                        </div>
                        <div>
                            <button class="btn" onclick="approveInvite('${notification.data.email}')" style="background: #28a745; margin: 2px;">‚úÖ Aprovar</button>
                            <button class="btn" onclick="rejectInvite('${notification.id}')" style="background: #dc3545; margin: 2px;">‚ùå Rejeitar</button>
                            <button class="btn" onclick="markAsRead('${notification.id}')" style="background: #6c757d; margin: 2px;">üëÅÔ∏è Marcar Lida</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar lista de convites pendentes
        function updateInvitesList() {
            const invitesDiv = document.getElementById('invitesList');
            
            if (invites.length === 0) {
                invitesDiv.innerHTML = '<p style="color: #666; text-align: center;">Nenhum convite pendente.</p>';
                return;
            }
            
            invitesDiv.innerHTML = invites.filter(invite => invite.status === 'pending').map(invite => `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">‚è≥ Aguardando Aprova√ß√£o</h4>
                    <p><strong>Nome:</strong> ${invite.fullName}</p>
                    <p><strong>Email:</strong> ${invite.email}</p>
                    <p><strong>Telefone:</strong> ${invite.phone}</p>
                    <p><strong>Cadastrado em:</strong> ${invite.invitedAt}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="approveInvite('${invite.email}')" style="background: #28a745;">‚úÖ Aprovar e Cadastrar</button>
                        <button class="btn" onclick="rejectInvite('${invite.id}')" style="background: #dc3545;">‚ùå Rejeitar</button>
                    </div>
                </div>
            `).join('');
        }

        // Aprovar convite e cadastrar pessoa
        function approveInvite(email) {
            const invite = invites.find(inv => inv.email === email);
            if (!invite) return;
            
            // Verificar se j√° n√£o est√° cadastrado
            if (people.find(p => p.email === email)) {
                alert('Esta pessoa j√° est√° cadastrada no sistema.');
                return;
            }
            
            // Adicionar √† lista de pessoas (sem foto por enquanto)
            const newPerson = {
                id: Date.now(),
                fullName: invite.fullName,
                email: invite.email,
                phone: invite.phone,
                photo: null, // Ser√° adicionada quando a pessoa fizer o reconhecimento
                registeredAt: new Date().toLocaleString('pt-BR'),
                approvedAt: new Date().toLocaleString('pt-BR'),
                fromInvite: true
            };
            
            people.push(newPerson);
            
            // Marcar convite como aprovado
            invite.status = 'approved';
            invite.approvedAt = new Date().toLocaleString('pt-BR');
            
            saveDataToHTML(); // Sincronizar automaticamente
            
            alert(`${invite.fullName} foi aprovado(a) e cadastrado(a) no sistema!`);
            updatePersonList();
            updateInvitesList();
            updateNotifications();
        }

        // Rejeitar convite
        function rejectInvite(inviteId) {
            if (confirm('Tem certeza que deseja rejeitar este cadastro?')) {
                const inviteIndex = invites.findIndex(inv => inv.id == inviteId);
                if (inviteIndex > -1) {
                    invites[inviteIndex].status = 'rejected';
                    invites[inviteIndex].rejectedAt = new Date().toLocaleString('pt-BR');
                    saveDataToHTML(); // Sincronizar automaticamente
                }
                
                // Remover notifica√ß√£o
                const notifications = JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]');
                const filteredNotifications = notifications.filter(n => n.id != inviteId);
                localStorage.setItem('faceRecognitionNotifications', JSON.stringify(filteredNotifications));
                
                updateInvitesList();
                updateNotifications();
            }
        }

        // Marcar notifica√ß√£o como lida
        function markAsRead(notificationId) {
            const notifications = JSON.parse(localStorage.getItem('faceRecognitionNotifications') || '[]');
            const notification = notifications.find(n => n.id == notificationId);
            if (notification) {
                notification.read = true;
                localStorage.setItem('faceRecognitionNotifications', JSON.stringify(notifications));
                updateNotifications();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'971b4a0fb7b2ba31',t:'MTc1NTYyMzY4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
